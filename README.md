# Keonik1_infra
Keonik1 Infra repository

# Pritunl
bastion_IP = 51.250.84.164
someinternalhost_IP = 10.128.0.4

# Testapp
testapp_IP = 84.201.175.3
testapp_port = 9292


# ДЗ5 
## Сделано:
- Установлен packer
- Сделаны конфигурационные файлы ВМ (`*.pkr.hcl` и `.json`) для последующей установки reddit-monolith приложения
- Секреты были вынесены в отдельный файл с переменными
- Создан образ ВМ и запущено на нем приложение.

Для создания образа использовать команду
```bash
packer build -var-file="./variables.pkr.hcl" ./ubuntu16.pkr.hcl
```

# ДЗ6
## Чеклист
- [x] Основное ДЗ
- [x] Задания со звездочками

## Сделано
- Добавлен файл `terraform/main.tf`, который содержит конфигурацию ноды с приложением
- Добавлен файл `terraform/lb.tf`, который содержит конфигурацию для load balancer
- Добавлен файл `terraform/outputs.tf`, который содержит конфигурацию для load balancer
- Добавлена автоматическая установка приложения при развертывании
- Значения данных вынесены в файл `terraform/terraform.tfvars`
- Добавлен файл `terraform/terraform.example.tfvars`, в котором определены переменные
- Добавлен файл `terraform/variables.tf`, в котором инициализированы переменные.
- Добавлены файды для развертывания приложения в директорию `terraform/files/`

Для запуска приложения использовать команды:
```bash
terraform init
terraform plan
terraform apply -auto-approve
```
Для того чтобы обавить кастомный файл переменных использовать ключ `-var-file` ко всем командам

Для удаления инфраструктуры используется команда:
```bash
terraform destroy
```

Для обновления статуса текущих ресурсов использовать команду 
```bash
terraform refresh
```

# ДЗ7
## Чеклист
- [x] Основное ДЗ
- [ ] Задания со звездочками

## Сделано
- Добавлены два локальных модуля terrafrom - db и app
- В каждом модуле созданы файлы:
  - `main.tf` с описанием сервиса
  - `outputs.tf` с данными для вывода
  - `variables.tf` с переменными
  - `versions.tf` с данными об используемых версиях
- Добавлены 2 окружения - prod и stage
- В каждом окружении созданы файлы:
  - `main.tf` - содержит настройки провайдера и список сервисов для создания, а также переменные которые передаются в настройки модулей
  - `outputs.tf` - данные для вывода
  - `variables.tf` - переменые для использования в сервисах
  - `version.tf` - данные об используемых версиях
  - `terrafor.tfvars` - значения переменных для использования
  - `terrafor.tfvars.example` - шаблон со значениями переменных для использования

1. Для инициализации модулей используется или `terraform init` или `terraform get`
2. В каждом модулей должен быть файл с определением `required_provider`

# ДЗ8
## Чеклист
- [x] Основное ДЗ
- [ ] Задания со звездочками

## Сделано
- Добавлена папка проекта для ansible
- Создан файл ansible.cfg, который определяет стандартные настройки, такие как инвентарь (список нод для обслуживания), удаленный пользователь управления, и настройки ssh подключения
- Созданы файл inventory и inventory.yml, которые хранят одинаковые данные - ноды для обслуживания.
- Создан плейбук - clone.yml, который выполняет определенные действия на удаленном хосте - скачивание проекта с гитхаба.


# ДЗ9
## Чеклист
- [x] Основное ДЗ
- [ ] Задания со звездочками

## Сделано
- Добавлены playbook'и:
  - `app.yml` - содержит описание того как настраивать Reddit приложение
  - `db.yml` - содержит описание того как настраивать и запускать MongoDB
  - `deploy.yml` - содрежит описание того как публиковать приложение Reddit
  - `packer_app.yml` - содержит описание того как создавать образ для работы приложения Reddit
  - `packer_db.yml` - содержит описание того как создавать образ для работы MongoDB
  - `reddit_app_multiple_plays.yml` - Объединяет в себе `app`, `db` и `deploy` плейбуки
    - Для запуска использовать `ansible-playbook reddit_app2.yml --tags <tag>`, где `<tag>` заменяется на один из тегов внутри - `db-tag`, `app-tag`, `deploy-tag`
  - `reddit_app_one_play.yml` - объединяет в себе `app`, `db` и `deploy` плейбуки
    - Для запуска использовать `ansible-playbook reddit_app.yml --limit <hosts_type> --tags deploy-tag`, где 
      - `<tag>` заменяется на один из тегов внутри - `db-tag`, `app-tag`, `deploy-tag`
      - `<hosts_type>` заменяется на один из типо хостов в инвентаре - `db` или `app`
  - `site.yml` - объединяет в себе `app`, `db` и `deploy` плейбуки, но через `import_playbook`
    - Для запуска использовать `ansible-playbook site.yml`
- Обновлен файл `ansible.cfg` - файл инвентаря заменен на yml
- Файлы пакера обновлены на использование ansible плейбуков - `packer_app.yml` `packer_db.yml`
- Добавлены файлы шаблонов для настройки подключения к БД (`db_config.j2`) и настройки сабой БД (mongod.conf.j2)

При возникновении проблем с packer при создании образа (`failed handshake`) - зайти в дирректорию packer и сделать `packer init ./config.pkr.hcl`

# ДЗ9
## Чеклист
- [x] Основное ДЗ
- [ ] Задания со звездочками

## Сделано
1. Плейбуки перемещены в папку `ansible/playbooks`
2. Добавлены окружения `prod` и `stage` - `ansible/environments`
    - в каждом окружении настроены переменные для использования в ролях `app`, `db` или `all`
    - в каждом окружении хранится файл с настройками пользователей, которые будут созданы на хостах
    - в каждом окружении хранится собственный список хостов
    - в каждом окружении хранится список требуемых модулей
3. Плейбуки `app` и `db` обновлены на использование ролей
4. Добавлен плейбук `users` для создания пользователей
5. Добавлены роли `app` и `db`, в которые перенесен функционал для исполнения плейбуков app и db, соответветсвенно
6. В конфиг файл ансибла добавлена секция `diff` и параметр для ключа шифрования ансибл
7. 
